<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>HTTPS 协议是如何握手的 - 大猫的比特垃圾桶</title><meta name=Description content><meta property="og:title" content="HTTPS 协议是如何握手的"><meta property="og:description" content="Hypertext Transfer Protocol Secure (HTTPS) is an extension of the Hypertext Transfer Protocol (HTTP). It is used for secure communication over a computer network, and is widely used on the Internet. In HTTPS, the communication protocol is encrypted using Transport Layer Security (TLS) or, formerly, its predecessor, Secure Sockets Layer (SSL). The protocol is therefore also often referred to as HTTP over TLS, or HTTP over SSL. HTTPS (Hypertext Transfer"><meta property="og:type" content="article"><meta property="og:url" content="https://aladdinding.cn/https%E5%8D%8F%E8%AE%AE%E6%98%AF%E5%A6%82%E4%BD%95%E6%8F%A1%E6%89%8B%E7%9A%84/"><meta property="og:image" content="https://aladdinding.cn"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-23T18:38:50+08:00"><meta property="article:modified_time" content="2021-11-23T18:38:50+08:00"><meta property="og:site_name" content="大猫's Bitbucket"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://aladdinding.cn"><meta name=twitter:title content="HTTPS 协议是如何握手的"><meta name=twitter:description content="Hypertext Transfer Protocol Secure (HTTPS) is an extension of the Hypertext Transfer Protocol (HTTP). It is used for secure communication over a computer network, and is widely used on the Internet. In HTTPS, the communication protocol is encrypted using Transport Layer Security (TLS) or, formerly, its predecessor, Secure Sockets Layer (SSL). The protocol is therefore also often referred to as HTTP over TLS, or HTTP over SSL. HTTPS (Hypertext Transfer"><meta name=application-name content="大猫's Bitbucket"><meta name=apple-mobile-web-app-title content="大猫's Bitbucket"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://aladdinding.cn/https%E5%8D%8F%E8%AE%AE%E6%98%AF%E5%A6%82%E4%BD%95%E6%8F%A1%E6%89%8B%E7%9A%84/><link rel=prev href=https://aladdinding.cn/golang%E4%B8%AD%E7%9A%84stringrune%E5%92%8Cbyte/><link rel=next href=https://aladdinding.cn/%E6%AD%A6%E6%B1%89%E6%B5%B7%E6%98%8C%E6%9E%81%E5%9C%B0%E6%B5%B7%E6%B4%8B%E4%B8%96%E7%95%8C%E6%B8%B8%E7%8E%A9tips/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"HTTPS 协议是如何握手的","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/aladdinding.cn\/https%E5%8D%8F%E8%AE%AE%E6%98%AF%E5%A6%82%E4%BD%95%E6%8F%A1%E6%89%8B%E7%9A%84\/"},"genre":"posts","keywords":"https","wordcount":3234,"url":"https:\/\/aladdinding.cn\/https%E5%8D%8F%E8%AE%AE%E6%98%AF%E5%A6%82%E4%BD%95%E6%8F%A1%E6%89%8B%E7%9A%84\/","datePublished":"2021-11-23T18:38:50+08:00","dateModified":"2021-11-23T18:38:50+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"大猫"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=大猫的比特垃圾桶><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>时间轴 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=大猫的比特垃圾桶><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>时间轴</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">HTTPS 协议是如何握手的</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>大猫</a>
</span>&nbsp;<span class=post-category>included in <a href=/categories/%E5%8D%8F%E8%AE%AE/><i class="far fa-folder fa-fw" aria-hidden=true></i>协议</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2021-11-23>2021-11-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3234 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#tls-报文格式>TLS 报文格式</a><ul><li><a href=#记录层协议tls-record-protocol>记录层协议（TLS Record Protocol）</a></li><li><a href=#握手协议tls-handshaking-protocols>握手协议（TLS Handshaking Protocols）</a></li></ul></li><li><a href=#tlsssl-握手流程>TLS/SSL 握手流程</a><ul><li><a href=#client-helloclient---server>Client Hello(Client -> Server)</a></li><li><a href=#server-helloserver---client>Server Hello(Server -> Client)</a></li><li><a href=#certificateserver---client>Certificate(Server -> Client)</a></li><li><a href=#server-key-exchangeserver---client>Server Key Exchange(Server -> Client)</a></li><li><a href=#certificate-requestserver---client-可选>Certificate Request(Server -> Client, 可选）</a></li><li><a href=#server-hello-doneserver---client>Server Hello Done(Server -> Client)</a></li><li><a href=#certificateclient---server-可选>Certificate(Client -> Server, 可选）</a></li><li><a href=#client-key-exchangeclient---server>Client Key Exchange(Client -> Server)</a></li><li><a href=#change-cipher-specclient---server>Change Cipher Spec(Client -> Server)</a></li><li><a href=#encrypted-handshake-messageclient---server-也称-finshed>Encrypted Handshake Message(Client -> Server, 也称 Finshed)</a></li><li><a href=#change-cipher-specserver---client>Change Cipher Spec(Server -> Client)</a></li><li><a href=#encrypted-handshake-messageserver---client-也称-finshed>Encrypted Handshake Message(Server -> Client, 也称 Finshed)</a></li><li><a href=#application_dataclient---server>APPLICATION_DATA(CLient &lt;-> Server)</a></li></ul></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></div></div><div class=content id=content><blockquote><p>Hypertext Transfer Protocol Secure (HTTPS) is an extension of the Hypertext Transfer Protocol (HTTP). It is used for secure communication over a computer network, and is widely used on the Internet. In HTTPS, the communication protocol is encrypted using Transport Layer Security (TLS) or, formerly, its predecessor, Secure Sockets Layer (SSL). The protocol is therefore also often referred to as HTTP over TLS, or HTTP over SSL.</p><p>HTTPS (Hypertext Transfer Protocol Secure) 是基于 HTTP 的扩展，用于计算机网络的安全通信，已经在互联网得到广泛应用。在 HTTPS 中，原有的 HTTP 协议会得到 TLS （安全传输层协议） 或其前辈 SSL （安全套接层） 的加密。因此 HTTPS 也常指 HTTP over TLS 或 HTTP over SSL。</p></blockquote><h2 id=tls-报文格式>TLS 报文格式</h2><p>TLS 协议各种通常分为两部分：</p><ul><li>靠近应用层的握手协议 TLS Handshaking Protocols</li><li>靠近 TCP 的记录层协议 TLS Record Protocol</li></ul><h3 id=记录层协议tls-record-protocol>记录层协议（TLS Record Protocol）</h3><p>记录层协议也可以理解为报文头（TLS Record header），占用 5 个字节</p><ol><li>第 1 个字节是类型（Record Type Values），目前有 4 种类型</li><li>第 2-3 字节是版本（Version Values），目前有 4 种版本</li><li>第 4-5 字节是长度（不包含 TLS 报文头本身长度）</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>           record type (1 byte)
</span></span><span class=line><span class=cl>          /
</span></span><span class=line><span class=cl>         /    version (1 byte major, 1 byte minor)
</span></span><span class=line><span class=cl>        /    /
</span></span><span class=line><span class=cl>       /    /         length (2 bytes)
</span></span><span class=line><span class=cl>      /    /         /
</span></span><span class=line><span class=cl>   +----+----+----+----+----+
</span></span><span class=line><span class=cl>   |    |    |    |    |    |
</span></span><span class=line><span class=cl>   |    |    |    |    |    | TLS Record header
</span></span><span class=line><span class=cl>   +----+----+----+----+----+
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Record Type Values       dec      hex
</span></span><span class=line><span class=cl>   -------------------------------------
</span></span><span class=line><span class=cl>   CHANGE_CIPHER_SPEC        20     0x14
</span></span><span class=line><span class=cl>   ALERT                     21     0x15
</span></span><span class=line><span class=cl>   HANDSHAKE                 22     0x16
</span></span><span class=line><span class=cl>   APPLICATION_DATA          23     0x17
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Version Values            dec     hex
</span></span><span class=line><span class=cl>   -------------------------------------
</span></span><span class=line><span class=cl>   SSL 3.0                   3,0  0x0300
</span></span><span class=line><span class=cl>   TLS 1.0                   3,1  0x0301
</span></span><span class=line><span class=cl>   TLS 1.1                   3,2  0x0302
</span></span><span class=line><span class=cl>   TLS 1.2                   3,3  0x0303
</span></span></code></pre></td></tr></table></div></div><h3 id=握手协议tls-handshaking-protocols>握手协议（TLS Handshaking Protocols）</h3><p>TLS 握手协议还能细分为 5 个子协议：</p><ul><li>change_cipher_spec （密码切换协议，在 TLS 1.3 中这个协议已经删除，为了兼容 TLS 老版本，可能还会存在）</li><li>alert（警告协议，用来表示关闭信息和错误）</li><li>handshake（握手协议，TLS 协议簇中最最核心的协议）</li><li>application_data（应用数据协议）</li><li>heartbeat （心跳协议，这个是 TLS 1.3 新加的，TLS 1.3 之前的版本没有这个协议）</li></ul><p>以记录类型为 handshake 举例：</p><p>其中 Handshake 协议中有 10 种握手消息类型（不计算扩展），格式如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>                           |
</span></span><span class=line><span class=cl>         Record Layer      |  Handshake Layer
</span></span><span class=line><span class=cl>                           |                                  |
</span></span><span class=line><span class=cl>                           |                                  |  ...more messages
</span></span><span class=line><span class=cl>  +----+----+----+----+----+----+----+----+----+------ - - - -+--
</span></span><span class=line><span class=cl>  | 22 |    |    |    |    |    |    |    |    |              |
</span></span><span class=line><span class=cl>  |0x16|    |    |    |    |    |    |    |    |message       |
</span></span><span class=line><span class=cl>  +----+----+----+----+----+----+----+----+----+------ - - - -+--
</span></span><span class=line><span class=cl>    /               /      | \    \----\-----\                |
</span></span><span class=line><span class=cl>   /               /       |  \\
</span></span><span class=line><span class=cl>  type: 22        /        |   \         handshake message length
</span></span><span class=line><span class=cl>                 /              type
</span></span><span class=line><span class=cl>                /
</span></span><span class=line><span class=cl>           length: arbitrary (up to 16k)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Handshake Type Values    dec      hex
</span></span><span class=line><span class=cl>   -------------------------------------
</span></span><span class=line><span class=cl>   HELLO_REQUEST              0     0x00
</span></span><span class=line><span class=cl>   CLIENT_HELLO               1     0x01
</span></span><span class=line><span class=cl>   SERVER_HELLO               2     0x02
</span></span><span class=line><span class=cl>   CERTIFICATE               11     0x0b
</span></span><span class=line><span class=cl>   SERVER_KEY_EXCHANGE       12     0x0c
</span></span><span class=line><span class=cl>   CERTIFICATE_REQUEST       13     0x0d
</span></span><span class=line><span class=cl>   SERVER_DONE               14     0x0e
</span></span><span class=line><span class=cl>   CERTIFICATE_VERIFY        15     0x0f
</span></span><span class=line><span class=cl>   CLIENT_KEY_EXCHANGE       16     0x10
</span></span><span class=line><span class=cl>   FINISHED                  20     0x14
</span></span></code></pre></td></tr></table></div></div><h2 id=tlsssl-握手流程>TLS/SSL 握手流程</h2><ol><li>在交换 Hello 信息中，交换随机数，协商出后续使用的加密套件和对应的算法</li><li>单向/双向发送证书允许客户端和服务端进行身份认证</li><li>Server/Client key Exchange 根据选择的算法交换相应参数，协商出<strong>预备主密钥</strong></li><li>双端通过<strong>预备主密钥</strong>、随机数计算出<strong>主密钥</strong>，用于后续的对称加密数据传输</li></ol><p>完整的握手流程：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>     Client                                               Server
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      ClientHello                  --------&gt;
</span></span><span class=line><span class=cl>                                                      ServerHello
</span></span><span class=line><span class=cl>                                                     Certificate*
</span></span><span class=line><span class=cl>                                               ServerKeyExchange*
</span></span><span class=line><span class=cl>                                              CertificateRequest*
</span></span><span class=line><span class=cl>                                   &lt;--------      ServerHelloDone
</span></span><span class=line><span class=cl>      Certificate*
</span></span><span class=line><span class=cl>      ClientKeyExchange
</span></span><span class=line><span class=cl>      CertificateVerify*
</span></span><span class=line><span class=cl>      [ChangeCipherSpec]
</span></span><span class=line><span class=cl>      Finished                     --------&gt;
</span></span><span class=line><span class=cl>                                               [ChangeCipherSpec]
</span></span><span class=line><span class=cl>                                   &lt;--------             Finished
</span></span><span class=line><span class=cl>      Application Data             &lt;-------&gt;     Application Data
</span></span></code></pre></td></tr></table></div></div><p><code>*</code>表示着此阶段在某些条件下不存在，<code>[]</code>表示不属于握手报文</p><h3 id=client-helloclient---server>Client Hello(Client -> Server)</h3><p>主要作用是告诉 Server，Client 所支持的 TLS 协议版本、支持的加密算法等等。</p><figure><a class=lightgallery href=https://img.aladdinding.cn/20211123173731.png title=https://img.aladdinding.cn/20211123173731.png data-thumbnail=https://img.aladdinding.cn/20211123173731.png data-sub-html="<h2>Client Hello</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=https://img.aladdinding.cn/20211123173731.png data-srcset="https://img.aladdinding.cn/20211123173731.png, https://img.aladdinding.cn/20211123173731.png 1.5x, https://img.aladdinding.cn/20211123173731.png 2x" data-sizes=auto alt=https://img.aladdinding.cn/20211123173731.png></a><figcaption class=image-caption>Client Hello</figcaption></figure><p><strong>Client 随机数（Random）</strong>：Client 生成的随机数，暂时称作 ClientHello random，用于后续的主密钥生成。</p><p><strong>会话 ID（Session ID）</strong>：当 Client 通过一次完整的握手，与 Server 建立了一次完整的 Session，Server 会记录这次 Session 的信息，以备恢复会话的时候使用。上图中该字段为空，说明这是第一次连接到服务器。</p><p><strong>加密算法套件（Cipher Suite）</strong>：包含了 Client 所支持的密码算法套件。TLS 中使用的密码套件有一种标准格式。上面的抓包中，Client 发送了 46 套加密套件，Server 会从中选出一种用于本次加密连接使用。一个加密算法套件是 4 个算法的组合。</p><p><strong>压缩方法（Compression Methods）</strong>：加密之前的压缩算法。这个字段在 TLS 1.2 中用的不多。在 TLS 1.3 中这个字段被删除。</p><p><strong>扩展（Extension）</strong>：结构定义是一个枚举类型，用于携带一些扩展参数，加强 TLS 功能。（携带域名，是否支持 http/2.0 等等）</p><h3 id=server-helloserver---client>Server Hello(Server -> Client)</h3><p>收到 Client Hello 之后服务器必须发送 Server Hello 信息，Server 会检查 TLS 版本和算法的 Client Hello 的条件，如果服务器接受并支持所有条件，它将发送其证书以及其他详细信息。否则，服务器将发送握手失败消息。</p><figure><a class=lightgallery href=https://img.aladdinding.cn/20211123175422.png title=https://img.aladdinding.cn/20211123175422.png data-thumbnail=https://img.aladdinding.cn/20211123175422.png data-sub-html="<h2>Server Hello</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=https://img.aladdinding.cn/20211123175422.png data-srcset="https://img.aladdinding.cn/20211123175422.png, https://img.aladdinding.cn/20211123175422.png 1.5x, https://img.aladdinding.cn/20211123175422.png 2x" data-sizes=auto alt=https://img.aladdinding.cn/20211123175422.png></a><figcaption class=image-caption>Server Hello</figcaption></figure><p><strong>Server 随机数（Random）</strong>：Server 生成的随机数，暂时称作 ServerHello random。注意，至此 Client 和 Server 都拥有了两个随机数。</p><p><strong>会话 ID（Session ID）</strong>：服务器将约定的 Session 参数存储在 TLS 缓存中，并生成与其对应的 Session id。它与 Server Hello 一起发送到 Client。Client 可以写入约定的参数到此 Session id，并给定到期时间。Client 将在 Client Hello 中包含此 id。如果 Client 在此到期时间之前再次连接到服务器，则服务器可以检查与 Session id 对应的缓存参数，并重用它们而无需完全握手。这非常有用，因为服务器和 Client 都可以节省大量的计算成本。</p><p><strong>加密算法套件（Cipher Suite）</strong>：抓包中 Server 选择了 TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xc02f)，其中密钥协商算法是 ECDHE、身份认证算法是 RSA、加密模式是 AES_128_GCM、消息认证码算法（MAC）是 SHA256。</p><p><strong>压缩方法（Compression Methods）</strong>：如果支持，服务器将同意 Client 的首选压缩方法。</p><p><strong>扩展（Extension）</strong>：同上，只有由 Client 给出的扩展才能出现在 Server 的列表中。</p><h3 id=certificateserver---client>Certificate(Server -> Client)</h3><p>Server 将数字证书和到根 CA 整个链发给 Client，使得 Client 能用证书中公钥进行认证。</p><figure><a class=lightgallery href=https://img.aladdinding.cn/20211123175545.png title=https://img.aladdinding.cn/20211123175545.png data-thumbnail=https://img.aladdinding.cn/20211123175545.png data-sub-html="<h2>Certificate</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=https://img.aladdinding.cn/20211123175545.png data-srcset="https://img.aladdinding.cn/20211123175545.png, https://img.aladdinding.cn/20211123175545.png 1.5x, https://img.aladdinding.cn/20211123175545.png 2x" data-sizes=auto alt=https://img.aladdinding.cn/20211123175545.png></a><figcaption class=image-caption>Certificate</figcaption></figure><h3 id=server-key-exchangeserver---client>Server Key Exchange(Server -> Client)</h3><p>主要作用是根据不同的密钥协商算法交换必要的密码信息。</p><p>如果密钥协商算法是 (EC)DHE，所以需要此阶段传递 DH 参数和 DH 公钥。</p><p>如果密钥协商算法为 RSA ，Client 不需要额外参数就可以计算出<strong>预备主密钥</strong>，然后使用 Server Certificate 中的公钥加密发送给 Server，所以不需要此阶段。</p><figure><a class=lightgallery href=https://img.aladdinding.cn/20211123175625.png title=https://img.aladdinding.cn/20211123175625.png data-thumbnail=https://img.aladdinding.cn/20211123175625.png data-sub-html="<h2>Server Key Exchange</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=https://img.aladdinding.cn/20211123175625.png data-srcset="https://img.aladdinding.cn/20211123175625.png, https://img.aladdinding.cn/20211123175625.png 1.5x, https://img.aladdinding.cn/20211123175625.png 2x" data-sizes=auto alt=https://img.aladdinding.cn/20211123175625.png></a><figcaption class=image-caption>Server Key Exchange</figcaption></figure><h3 id=certificate-requestserver---client-可选>Certificate Request(Server -> Client, 可选）</h3><p>这一步是可选的，如果有则表示双向认证。如果在对安全性要求高的常见可能用到。服务器用来验证 Client。服务器端发出 Certificate Request 消息，要求 Client 发他自己的证书过来进行验证。例如银行给你发的 USB 盾牌。</p><h3 id=server-hello-doneserver---client>Server Hello Done(Server -> Client)</h3><p>此消息完成握手协商的服务器部分，它不携带任何附加信息。</p><p>从 Server Hello 到 Server Hello Done，有些 Server 的实现是每条单独发送，有 Server 实现是合并到一起发送。Sever Hello 和 Server Hello Done 都是只有头没有内容的数据。</p><figure><a class=lightgallery href=https://img.aladdinding.cn/20211123175639.png title=https://img.aladdinding.cn/20211123175639.png data-thumbnail=https://img.aladdinding.cn/20211123175639.png data-sub-html="<h2>Server Hello Done</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=https://img.aladdinding.cn/20211123175639.png data-srcset="https://img.aladdinding.cn/20211123175639.png, https://img.aladdinding.cn/20211123175639.png 1.5x, https://img.aladdinding.cn/20211123175639.png 2x" data-sizes=auto alt=https://img.aladdinding.cn/20211123175639.png></a><figcaption class=image-caption>Server Hello Done</figcaption></figure><h3 id=certificateclient---server-可选>Certificate(Client -> Server, 可选）</h3><p>如果 Server 要求发送 Client 证书，Client 便会在该阶段将自己的证书发送过去。Server 在之前发送的 Certificate Request 消息中包含了服务器端所支持的证书类型和 CA 列表，因此 Client 会在自己的证书中选择满足这两个条件的第一个证书发送过去。若 Client 没有证书，则发送一个 no_certificate 警告。</p><h3 id=client-key-exchangeclient---server>Client Key Exchange(Client -> Server)</h3><p>主要作用是交换或者协商出<strong>预备主密钥</strong>，用于<strong>主密钥</strong>的计算。</p><p>对于 RSA 握手协商算法来说，Client 会生成的一个 48 字节的<strong>预备主密钥</strong>，其中前 2 个字节是 ProtocolVersion，后 46 字节是随机数，用 Server 的公钥加密之后通过此阶段发给 Server，Server 用私钥来解密。</p><p>对于 (EC)DHE 密钥协商算法来说，<strong>预备主密钥</strong>是双方通过椭圆曲线算法生成的，双方各自生成临时公私钥对，保留私钥，将公钥发给对方，然后就可以用自己的私钥以及对方的公钥通过椭圆曲线算法来生成<strong>预备主密钥</strong>。此时传递的是 (EC)DHE 算法公钥（图中的 Pubkey），<strong>预备主密钥</strong>是密钥在双方不直接传递密钥的情况下得到的。</p><p>当 Server 获得了可以计算<strong>预备主密钥</strong>的所有条件后，结合之前的 ClientHello random 和 ServerHello random，通过伪随机函数 PRF 生成并截取 48 字节为<strong>主密钥</strong>，用于后续对称加密传输数据的密钥，Client 同理。</p><figure><a class=lightgallery href=https://img.aladdinding.cn/20211124152917.png title=https://img.aladdinding.cn/20211124152917.png data-thumbnail=https://img.aladdinding.cn/20211124152917.png data-sub-html="<h2>Client Key Exchange</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=https://img.aladdinding.cn/20211124152917.png data-srcset="https://img.aladdinding.cn/20211124152917.png, https://img.aladdinding.cn/20211124152917.png 1.5x, https://img.aladdinding.cn/20211124152917.png 2x" data-sizes=auto alt=https://img.aladdinding.cn/20211124152917.png></a><figcaption class=image-caption>Client Key Exchange</figcaption></figure><h3 id=change-cipher-specclient---server>Change Cipher Spec(Client -> Server)</h3><p>主要作用是表明接下来传输数据过程中可以对应用数据协议进行加密了。</p><p>密码切换协议，表示随后的信息都将用双方商定的加密方法和密钥发送（Change Cipher Spec 是一个独立的协议，体现在数据包中就是一个字节的数据，用于告知 Server，Client 已经切换到之前协商好的加密套件（Cipher Suite）的状态，准备使用之前协商好的加密套件加密数据并传输了。其中第一条加密的消息就是接下来的 Encrypted Handshake Message</p><figure><a class=lightgallery href=https://img.aladdinding.cn/20211124153942.png title=https://img.aladdinding.cn/20211124153942.png data-thumbnail=https://img.aladdinding.cn/20211124153942.png data-sub-html="<h2>Change Cipher Spec</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=https://img.aladdinding.cn/20211124153942.png data-srcset="https://img.aladdinding.cn/20211124153942.png, https://img.aladdinding.cn/20211124153942.png 1.5x, https://img.aladdinding.cn/20211124153942.png 2x" data-sizes=auto alt=https://img.aladdinding.cn/20211124153942.png></a><figcaption class=image-caption>Change Cipher Spec</figcaption></figure><h3 id=encrypted-handshake-messageclient---server-也称-finshed>Encrypted Handshake Message(Client -> Server, 也称 Finshed)</h3><p>生成对称加密密钥之后，发送一条加密的数据，让 Server 解密验证，确认密钥的正确性。</p><figure><a class=lightgallery href=https://img.aladdinding.cn/20211124154002.png title=https://img.aladdinding.cn/20211124154002.png data-thumbnail=https://img.aladdinding.cn/20211124154002.png data-sub-html="<h2>Encrypted Handshake Message</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=https://img.aladdinding.cn/20211124154002.png data-srcset="https://img.aladdinding.cn/20211124154002.png, https://img.aladdinding.cn/20211124154002.png 1.5x, https://img.aladdinding.cn/20211124154002.png 2x" data-sizes=auto alt=https://img.aladdinding.cn/20211124154002.png></a><figcaption class=image-caption>Encrypted Handshake Message</figcaption></figure><h3 id=change-cipher-specserver---client>Change Cipher Spec(Server -> Client)</h3><p>密码切换协议，服务端和客户端一样，告诉客户端可以开始加密通信。</p><figure><a class=lightgallery href=https://img.aladdinding.cn/20211124161057.png title=https://img.aladdinding.cn/20211124161057.png data-thumbnail=https://img.aladdinding.cn/20211124161057.png data-sub-html="<h2>Change Cipher Spec</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=https://img.aladdinding.cn/20211124161057.png data-srcset="https://img.aladdinding.cn/20211124161057.png, https://img.aladdinding.cn/20211124161057.png 1.5x, https://img.aladdinding.cn/20211124161057.png 2x" data-sizes=auto alt=https://img.aladdinding.cn/20211124161057.png></a><figcaption class=image-caption>Change Cipher Spec</figcaption></figure><h3 id=encrypted-handshake-messageserver---client-也称-finshed>Encrypted Handshake Message(Server -> Client, 也称 Finshed)</h3><p>生成对称加密密钥之后，发送一条加密的数据，让客户端解密验证；如果对方可以解密，则双方认证无误开始通信。</p><figure><a class=lightgallery href=https://img.aladdinding.cn/20211124161121.png title=https://img.aladdinding.cn/20211124161121.png data-thumbnail=https://img.aladdinding.cn/20211124161121.png data-sub-html="<h2>Encrypted Handshake Message</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=https://img.aladdinding.cn/20211124161121.png data-srcset="https://img.aladdinding.cn/20211124161121.png, https://img.aladdinding.cn/20211124161121.png 1.5x, https://img.aladdinding.cn/20211124161121.png 2x" data-sizes=auto alt=https://img.aladdinding.cn/20211124161121.png></a><figcaption class=image-caption>Encrypted Handshake Message</figcaption></figure><h3 id=application_dataclient---server>APPLICATION_DATA(CLient &lt;-> Server)</h3><p>这个阶段就很简单了，数据开始加密传输，其中<code>Record Type Values </code>为 <code>Application Data（23）</code></p><figure><a class=lightgallery href=https://img.aladdinding.cn/20211124182033.png title=https://img.aladdinding.cn/20211124182033.png data-thumbnail=https://img.aladdinding.cn/20211124182033.png data-sub-html="<h2>APPLICATION_DATA</h2>"><img class=lazyload src=/svg/loading.min.svg data-src=https://img.aladdinding.cn/20211124182033.png data-srcset="https://img.aladdinding.cn/20211124182033.png, https://img.aladdinding.cn/20211124182033.png 1.5x, https://img.aladdinding.cn/20211124182033.png 2x" data-sizes=auto alt=https://img.aladdinding.cn/20211124182033.png></a><figcaption class=image-caption>APPLICATION_DATA</figcaption></figure><h2 id=参考>参考</h2><ol><li><a href=https://megamorf.gitlab.io/2020/03/03/traffic-analysis-of-a-tls-session/#handshake-protocol-format target=_blank rel="noopener noreffer">Traffic analysis of a TLS session</a></li><li><a href=https://datatracker.ietf.org/doc/html/rfc5246 target=_blank rel="noopener noreffer">The Transport Layer Security (TLS) Protocol Version 1.2</a></li><li><a href=https://halfrost.com/tag/https/ target=_blank rel="noopener noreffer">HTTPS 温故知新系列——冰霜大佬</a></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-11-23</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/https/>https</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/golang%E4%B8%AD%E7%9A%84stringrune%E5%92%8Cbyte/ class=prev rel=prev title=Golang中的string、rune和byte><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Golang中的string、rune和byte</a>
<a href=/%E6%AD%A6%E6%B1%89%E6%B5%B7%E6%98%8C%E6%9E%81%E5%9C%B0%E6%B5%B7%E6%B4%8B%E4%B8%96%E7%95%8C%E6%B8%B8%E7%8E%A9tips/ class=next rel=next title=武汉海昌极地海洋世界游玩tips>武汉海昌极地海洋世界游玩tips<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>大猫</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a href=https://beian.miit.gov.cn/ rel="noopener noreferrer" target=_blank>鄂ICP备2021016339号-1</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.4.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@8.5.4/dist/index.umd.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:100},comment:{utterances:{darkTheme:"github-dark",issueTerm:"og:title",label:"",lightTheme:"github-light",repo:"munding/aladdinding.github.io"}},data:{"id-1":"/dev/null","id-2":"/dev/null"},lightgallery:!0,search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:50,type:"lunr"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:100}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>